name: Igor

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2am UTC
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on (optional)'
        required: false
        type: string

# Prevent concurrent runs to avoid duplicate PRs
concurrency:
  group: claude-incremental
  cancel-in-progress: false

# Restrict default permissions - jobs override as needed
permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  find-work:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find.outputs.issue_number }}
      issue_body: ${{ steps.find.outputs.issue_body }}
      issue_title: ${{ steps.find.outputs.issue_title }}
    steps:
      - name: Find oldest labeled issue without an open PR
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          REPO="${{ github.repository }}"

          # Get head branch names of all open PRs with the label
          OPEN_PR_BRANCHES=$(gh pr list --repo "$REPO" --label "claude-incremental" --state open --json headRefName --jq '.[].headRefName')

          if [ -n "$INPUT_ISSUE_NUMBER" ]; then
            # Manual dispatch: use the specified issue but check for existing PR
            ISSUE_NUMBER="$INPUT_ISSUE_NUMBER"
            if echo "$OPEN_PR_BRANCHES" | grep -q "^claude-incremental/${ISSUE_NUMBER}-"; then
              echo "::notice::Issue #$ISSUE_NUMBER already has an open PR, skipping"
              exit 0
            fi
          else
            # Scheduled: find the oldest issue that doesn't already have an open PR
            ISSUES=$(gh issue list --repo "$REPO" --label "claude-incremental" --state open --json number,createdAt --jq 'sort_by(.createdAt) | .[].number')

            ISSUE_NUMBER=""
            for CANDIDATE in $ISSUES; do
              if ! echo "$OPEN_PR_BRANCHES" | grep -q "^claude-incremental/${CANDIDATE}-"; then
                ISSUE_NUMBER="$CANDIDATE"
                break
              fi
              echo "::notice::Issue #$CANDIDATE already has an open PR, skipping"
            done
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::notice::No eligible issues found"
            exit 0
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Fetch issue details
          ISSUE_DATA=$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')

          echo "issue_title<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  execute:
    needs: find-work
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js (root package.json)
        if: hashFiles('package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set up Node.js (website subdirectory)
        if: hashFiles('package.json') == '' && hashFiles('website/package.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'website/package-lock.json'

      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: npm ci

      - name: Install dependencies (website subdirectory)
        if: hashFiles('package.json') == '' && hashFiles('website/package.json') != ''
        working-directory: website
        run: npm ci

      - name: Create branch
        id: branch
        run: |
          BRANCH_NAME="claude-incremental/${{ needs.find-work.outputs.issue_number }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are working on an incremental project tracked in issue #${{ needs.find-work.outputs.issue_number }}.

            ## Issue Title
            ${{ needs.find-work.outputs.issue_title }}

            ## Issue Content
            ${{ needs.find-work.outputs.issue_body }}

            ## Instructions
            1. Read the issue and identify the first unchecked task (- [ ]) that is not marked as blocked
            2. Implement that task, making git commits as you go
            3. Run lint and tests, fix any issues:
               - JS/TS: npm run lint (from project root or website/ if that's where package.json lives)
               - Build: npm run build
               - Python: ruff check --fix && ruff format (if the project uses Python)
               - Python test: pytest path/to/file.py -v (if applicable)
            4. Push the changes you've made to GitHub and create a PR with the 'claude-incremental' label.
            5. After completing the task, update the issue using gh issue edit to:
               - Check off the completed task (change - [ ] to - [x])
               - Add any learnings to the ## Learnings section (create if needed)
            6. If you cannot complete the task, mark it as blocked (add "blocked:" prefix to the task)
            7. Add a comment to the issue summarizing what you did

            If all tasks are complete or blocked, comment on the issue explaining the status.
          claude_args: '--allowedTools "Bash(npm run lint:*),Bash(npm run type-check:*),Bash(npm run build:*),Bash(npm ci),Bash(npm install:*),Bash(ruff check:*),Bash(ruff format:*),Bash(pytest:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(gh pr create:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Read,Write,Edit"'


name: Igor

on:
  schedule:
    - cron: '0 2 * * *' # Daily at 2am UTC
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on (optional)'
        required: false
        type: string

# Prevent concurrent runs to avoid duplicate PRs
concurrency:
  group: claude-incremental
  cancel-in-progress: false

# Restrict default permissions - jobs override as needed
permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  find-work:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find.outputs.issue_number }}
      issue_body: ${{ steps.find.outputs.issue_body }}
      issue_title: ${{ steps.find.outputs.issue_title }}
    steps:
      - name: Find oldest labeled issue without an open PR
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          REPO="${{ github.repository }}"

          # Get head branch names of all open PRs with the label
          OPEN_PR_BRANCHES=$(gh pr list --repo "$REPO" --label "claude-incremental" --state open --json headRefName --jq '.[].headRefName')

          if [ -n "$INPUT_ISSUE_NUMBER" ]; then
            ISSUE_NUMBER="$INPUT_ISSUE_NUMBER"
            if echo "$OPEN_PR_BRANCHES" | grep -q "^claude-incremental/${ISSUE_NUMBER}-"; then
              echo "::notice::Issue #$ISSUE_NUMBER already has an open PR, skipping"
              exit 0
            fi
          else
            ISSUES=$(gh issue list --repo "$REPO" --label "claude-incremental" --state open --json number,createdAt --jq 'sort_by(.createdAt) | .[].number')

            ISSUE_NUMBER=""
            for CANDIDATE in $ISSUES; do
              if ! echo "$OPEN_PR_BRANCHES" | grep -q "^claude-incremental/${CANDIDATE}-"; then
                ISSUE_NUMBER="$CANDIDATE"
                break
              fi
              echo "::notice::Issue #$CANDIDATE already has an open PR, skipping"
            done
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::notice::No eligible issues found"
            exit 0
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          ISSUE_DATA=$(gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')

          echo "issue_title<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  implement:
    needs: find-work
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ISSUE_NUMBER: ${{ needs.find-work.outputs.issue_number }}
      ISSUE_TITLE: ${{ needs.find-work.outputs.issue_title }}
      ISSUE_BODY: ${{ needs.find-work.outputs.issue_body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create branch
        run: |
          SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | head -c 50)
          BRANCH="claude-incremental/${ISSUE_NUMBER}-${SLUG}"
          git checkout -b "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Run Claude to implement task
        run: |
          claude -p "You are Igor, an incremental worker. You are working on issue #$ISSUE_NUMBER.

          ISSUE TITLE: $ISSUE_TITLE

          ISSUE BODY:
          $ISSUE_BODY

          INSTRUCTIONS:
          1. Read the issue carefully and find the FIRST unchecked task (a line starting with '- [ ]' that does NOT start with '- [ ] blocked:')
          2. Implement ONLY that one task
          3. Make clean, well-tested changes
          4. Keep changes minimal and focused on the single task

          After implementing, output a summary of what you did." --allowedTools "Bash(git diff:*)" "Bash(git status:*)" "Bash(npm:*)" "Bash(npx:*)" "Bash(node:*)" "Read" "Write" "Edit"

      - name: Commit and push
        run: |
          git config user.name "igor[bot]"
          git config user.email "igor[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "::notice::No changes to commit"
            exit 0
          fi
          git commit -m "igor: implement task from #$ISSUE_NUMBER"
          git push origin "$BRANCH"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "igor: task from #$ISSUE_NUMBER - $ISSUE_TITLE" \
            --body "Automated implementation by Igor for issue #$ISSUE_NUMBER.

          ## Issue
          #$ISSUE_NUMBER

          ## What was done
          Implemented the first unchecked task from the tracking issue.

          ---
          *This PR was created automatically by the Igor workflow.*" \
            --label "claude-incremental" \
            --head "$BRANCH"

      - name: Update issue - check off task
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          claude -p "You need to update GitHub issue #$ISSUE_NUMBER in repo ${{ github.repository }}.

          The current issue body is:
          $ISSUE_BODY

          Find the task you just implemented (the first unchecked, non-blocked task) and check it off by changing '- [ ]' to '- [x]'.

          Also add a note under the '## Learnings' section about what you discovered while implementing.

          Use the gh CLI to update the issue body. Use: gh issue edit $ISSUE_NUMBER --repo ${{ github.repository }} --body '<new body>'

          IMPORTANT: Preserve all existing content. Only change the checkbox and add learnings." --allowedTools "Bash(gh:*)"
